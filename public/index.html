<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Landorix – Pinal County</title>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;background:#000;color:#fff;font-family:'Exo 2',sans-serif;}
    
    #preloader{
      position:fixed;top:0;left:0;width:100%;height:100%;background:#000;
      display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;
      transition:opacity 1.5s ease-out;
    }
    #preloader.fade{opacity:0;}
    h1{font-size:7rem;font-weight:300;letter-spacing:0.9rem;color:#fff;text-shadow:0 0 40px rgba(255,255,255,0.6);}
    .mountain{width:400px;height:210px;animation:float 7s ease-in-out infinite;filter:drop-shadow(0 0 25px rgba(255,255,255,0.4));}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-35px)}}

    #main{display:none;height:100%;}
    body.ready #main{display:block;}
    body.ready #preloader{display:none;}

    #map{height:100%;width:100%;}

    .title-box{
      position:absolute;top:20px;left:20px;z-index:1000;background:rgba(0,0,0,0.85);
      padding:18px 32px;border-radius:12px;backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.1);
    }

    /* Crisp white parcel outlines like official viewer */
    .parcel-path { stroke: #fff; stroke-width: 1; fill: none; opacity: 0.7; }
  </style>
</head>
<body>

  <div id="preloader">
    <h1>LANDORIX</h1>
    <svg class="mountain" viewBox="0 0 400 210" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 210 L200 70 L400 210 Z" fill="#222"/>
      <path d="M0 210 L200 90 L400 210 Z" fill="#444"/>
      <path d="M100 210 L200 120 L300 210 Z" fill="#999"/>
      <path d="M140 210 L200 150 L260 210 Z" fill="#fff"/>
    </svg>
  </div>

  <div id="main">
    <div id="map"></div>
    <div class="title-box">
      <h2 style="margin:0;font-size:2.4rem;letter-spacing:0.5rem;">LANDORIX</h2>
      <p style="margin:6px 0 0;font-size:1rem;opacity:0.9;">Pinal County – Full Parcel Boundaries</p>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Loader + map fix
    setTimeout(() => {
      document.getElementById('preloader').classList.add('fade');
      setTimeout(() => {
        document.body.classList.add('ready');
        setTimeout(() => map.invalidateSize(), 100);
      }, 1600);
    }, 3000);

    // Map – Pinal County
    const map = L.map('map', { zoomControl: false }).setView([32.88, -111.74], 10);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '©OpenStreetMap ©CartoDB'
    }).addTo(map);

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Load Pinal parcels via tiled GeoJSON queries (full coverage, no 404s)
    let parcelGroup = L.layerGroup().addTo(map);

    function loadParcelsInBounds(bounds) {
      const queryUrl = `https://rogue.casagrandeaz.gov/arcgis/rest/services/Pinal_County/Pinal_County_Parcels/MapServer/0/query?where=1%3D1&geometry=${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}&geometryType=esriGeometryEnvelope&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=APN,ACREAGE&returnGeometry=true&f=geojson&resultRecordCount=2000`;
      
      fetch(queryUrl)
        .then(response => response.json())
        .then(geojson => {
          L.geoJson(geojson, {
            style: {
              color: '#fff',
              weight: 1,
              fill: false,
              opacity: 0.7
            },
            onEachFeature: (feature, layer) => {
              if (feature.properties.APN) {
                layer.bindPopup(`<b>APN:</b> ${feature.properties.APN}<br><b>Acreage:</b> ${feature.properties.ACREAGE || 'N/A'}`);
              }
            }
          }).addTo(parcelGroup);
        })
        .catch(error => console.error('Parcel query error:', error));
    }

    // Initial load
    loadParcelsInBounds(map.getBounds());

    // Reload on move/zoom (debounced for performance)
    let timeout;
    map.on('moveend zoomend', () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        parcelGroup.clearLayers();
        loadParcelsInBounds(map.getBounds());
      }, 500);
    });
  </script>
</body>
</html>
